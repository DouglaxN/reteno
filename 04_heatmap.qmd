---
title: "04 - Process RNAseq Data"
author: "Douglas Nunes"
format: html
editor: visual
execute: 
  cache: true
---

## Loading required tables

```{r}
load(file = "RDatas/VULCONO_DGE_MICRNA.RData")
load(file = "RDatas/VULCONO_DGE_LNCRNA.RData")

load(file = "RDatas/DDS_DGE_ncRNAs.RData")
load(file = "RDatas/metadado_final.RData")
```

# HEATMAP - lncRNA

```{r}
# Filtrar os genes diferencialmente expressos (padj <= 0.05) 
filtro_DGE_lnc <- subset(DGE_lncRNA, padj <= 0.05)

# Removendo colunas para que o Objeto DDS fique como original 
filtro_DGE_lnc <- filtro_DGE_lnc[, 1:6]

# Seleciona os genes DGE 
heatmap_DGE_lnc <- rownames(filtro_DGE_lnc)

# Obter matriz de expressão normalizada, extração diretamente do objeto DESeq2
exp_genes_DGE_lnc <- dds_dge_filtred[rownames(DGE_lncRNA), ]

# Selecionar apenas genes significativos na matriz de expressão
idx_DGE_lnc <- rownames(exp_genes_DGE_lnc) %in% heatmap_DGE_lnc

# Criar uma nova matriz só com os genes DEGs selecionados com padj <= 0.05
exp_DGE_filtro_lnc <- assay(exp_genes_DGE_lnc[idx_DGE_lnc, ])


# Transformar valores de expressão em z-score para padj <= 0.01
exp_z_score_DGE_lnc <- t(apply(exp_DGE_filtro_lnc, 1, scale, center = T, scale = T))

colnames(exp_z_score_DGE_lnc) <- colnames(exp_DGE_filtro_lnc)
```

## plot heatmap

```{r}
# Anotação
coluna_anotacao <- data.frame(Grupo = metadado_final$type)
rownames(coluna_anotacao) <- rownames(metadado_final)

# Cores
cores_heatmap <- colorRampPalette(c("navy", "white", "firebrick3"))(100)

# Salvar
png("imgs/heatmap_DGE_RNA_lnc.png", width = 2500, height = 2000, res = 250)

# ✅ Plotando Heatmap ####
pheatmap(
  exp_z_score_DGE_lnc,
  annotation_col = coluna_anotacao,
  show_rownames = FALSE,
  cluster_cols = TRUE,
  cluster_rows = TRUE,
  color = cores_heatmap,
  fontsize = 10,
  border_color = NA,
  main = "Heatmap dos DGE - Reteno vs Controle \npadjust < 0.05",
  annotation_colors = list(Grupo = c(Control = "skyblue", Reteno = "tomato"))
)

dev.off()
```

# HEATMAP - miRNA

```{r}
# Filtrar os genes diferencialmente expressos (padj <= 0.05) 
filtro_DGE_mi <- DGE_miRNA

# Removendo colunas para que o Objeto DDS fique como original 
filtro_DGE_mi <- filtro_DGE_mi[, 1:6]

# Seleciona os genes DGE 
heatmap_DGE_mi <- rownames(filtro_DGE_mi)

# Obter matriz de expressão normalizada, extração diretamente do objeto DESeq2
exp_genes_DGE_mi <- dds_dge_filtred[rownames(DGE_miRNA), ]

# Selecionar apenas genes significativos na matriz de expressão
idx_DGE_mi <- rownames(exp_genes_DGE_mi) %in% heatmap_DGE_mi

# Criar uma nova matriz só com os genes DEGs selecionados com padj <= 0.05
exp_DGE_filtro_mi <- assay(exp_genes_DGE_mi[idx_DGE_mi, ])


# Transformar valores de expressão em z-score para padj <= 0.01
exp_z_score_DGE_mi <- t(apply(exp_DGE_filtro_mi, 1, scale, center = T, scale = T))

colnames(exp_z_score_DGE_mi) <- colnames(exp_DGE_filtro_mi)
```

## plot heatmap

```{r}
# Anotação
coluna_anotacao <- data.frame(Grupo = metadado_final$type)
rownames(coluna_anotacao) <- rownames(metadado_final)

# Cores
cores_heatmap <- colorRampPalette(c("navy", "white", "firebrick3"))(100)

# Salvar
png("imgs/heatmap_DGE_RNA_mi.png", width = 2500, height = 2000, res = 250)

# ✅ Plotando Heatmap ####
pheatmap(
  exp_z_score_DGE_mi,
  annotation_col = coluna_anotacao,
  show_rownames = FALSE,
  cluster_cols = TRUE,
  cluster_rows = TRUE,
  color = cores_heatmap,
  fontsize = 10,
  border_color = NA,
  main = "Heatmap dos DGE - Reteno vs Controle \npadjust < 0.05",
  annotation_colors = list(Grupo = c(Control = "skyblue", Reteno = "tomato"))
)

dev.off()
```

# Volcano plot

### Data construction for the volcano plot

```{r}
vulcano_DGE<- data.frame(res_time)

# Vulcano plot para DGE padj <= 0.015####
vulcano_DGE <- vulcano_DGE %>%
  # Garantir que colunas essenciais existem e estão limpas
  mutate(
    padj = ifelse(is.na(padj), 1, padj),                   # substitui NA por 1
    log2FoldChange = ifelse(is.na(log2FoldChange), 0, log2FoldChange),
    
    # Classificação dos genes
    signif = case_when(
      padj <= 0.05 & log2FoldChange > 1  ~ "Upregulated",
      padj <= 0.05 & log2FoldChange < -1 ~ "Downregulated",
      TRUE ~ "Not significant"
    ),
    
    # Ordem lógica dos fatores
    signif = factor(signif, levels = c("Downregulated", "Not significant", "Upregulated")),
    
    # Evitar Inf quando padj = 0
    padj = ifelse(padj == 0, 1e-300, padj),
    
    # Eixo Y do volcano plot
    log10padj = -log10(padj)
  )

# Calcular os valores a partir da tabela filtrada com padj <= 0.05
DGE_down_total <- sum(vulcano_DGE$signif == "Downregulated")
DGE_ns_total   <- sum(vulcano_DGE$signif == "Not significant")
DGE_up_total   <- sum(vulcano_DGE$signif == "Upregulated")
```

### Generating plot

```{r}
# Salvando o vulcano plot 
png("imgs/Vulcano_DGE_RNA_TOTAL.png", 
    width = 2000, 
    height = 2000, 
    res = 250)

# Criar Volcano plot usando ggplot2
ggplot(vulcano_DGE, aes(x = log2FoldChange, y = log10padj, color = signif)) +
  
  # Adicionar pontos representando os genes
  geom_point(alpha = 0.6, size = 1.4) +
  
  # Definir cores personalizadas para cada categoria de significância
  scale_color_manual(values = c(
    "Downregulated" = "#2166AC",
    "Not significant" = "gray80",
    "Upregulated" = "#B2182B"
  )) +
  
  # Adicionar linhas de corte (thresholds)
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black", linewidth = 0.3) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black", linewidth = 0.3) +
  
  # Anotar no gráfico com base nessa contagem
  annotate("text", x = -15, y = 75, label = paste("Down:", DGE_down_total), color = "#2166AC", hjust = 0) +
  annotate("text", x = 0, y = 75, label = paste("NS:", DGE_ns_total), color = "gray40", hjust = 0.5) +
  annotate("text", x = 15, y = 75, label = paste("Up:", DGE_up_total), color = "#B2182B", hjust = 1) +
  
  # Ajustar eixos com limites e espaçamento
  scale_x_continuous(limits = c(-15, 15), expand = expansion(mult = 0.02)) +
  scale_y_continuous(limits = c(0, 100), expand = expansion(mult = 0.02)) +
  
  # Títulos dos eixos e legenda
  labs(
    x = expression(log[2]~Fold~Change),
    y = expression(-log[10]~"adjusted p-value"),
    color = "Significance"
  ) +
  
  # Estilização geral do gráfico
  theme_minimal(base_size = 13, base_family = "Helvetica") +
  theme(
    panel.grid = element_blank(),
    legend.position = "top",
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10),
    axis.title = element_text(size = 13),
    axis.text = element_text(color = "black", size = 10),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    plot.subtitle = element_text(hjust = 0.5, size = 11)
  ) +
  ggtitle("Volcano Plot for the Differentially Expressed Genes (DGE)",         
          subtitle = "RNAs with padj < 0.05")

dev.off()

save(vulcano_DGE, DGE_down_total, DGE_ns_total, DGE_up_total, file = "RDatas/VULCONO_DGE_TOTAL.RData")

```

# ncRNA

## Filtering by RNA type

```{r}
# lncRNA 
lncRNA_list <- gff[gff$gene_type == "lncRNA",]
lncRNA_list$gene_id <- sub("\\.\\d+$", "", lncRNA_list$gene_id)

# mRNA
#mRNA_list <- gff[gff$gene_type == "protein_coding",]
#mRNA_list$gene_id <- sub("\\.\\d+$", "", mRNA_list$gene_id)

# miRNA
miRNA_list <- gff[gff$gene_type == "miRNA",]
miRNA_list$gene_id <- sub("\\.\\d+$", "", miRNA_list$gene_id)

# Salvando os genes alvos
genes_alvos <- c(lncRNA_list$gene_id, miRNA_list$gene_id)
```

## Preparing the gene counts table

```{r}
# Criando tabela filtrada 
counts_filtrada_biotipo <- gene_counts_total

# Garantindo que os IDs da tablea estejam limpos
rownames(counts_filtrada_biotipo) <- sub("\\.\\d+$", "", rownames(counts_filtrada_biotipo))

# Filtando a tabela para manter apenas os biotipos que estamos interessados
genes_presentes <- intersect(rownames(counts_filtrada_biotipo), genes_alvos)
counts_filtrada_biotipo <- counts_filtrada_biotipo[genes_presentes, ]
```

## Organizing metadata

```{r}
# Garantindo que o metadado tenha apenas as amostras 
metadado_final <- metadado_final[colnames(counts_filtrada_biotipo), ]

# Verificnando se os nomes batem exatamente 
print(ncol(counts_filtrada_biotipo) == nrow(metadado_final))
print(all(colnames(counts_filtrada_biotipo) == rownames(metadado_final)))
```

## DESEQ2

```{r}
# Removendo o h da coluna hours
metadado_final$hours <- gsub("h", "", metadado_final$hours)

# Converte a coluna type para fator (necessário para DESeq2)
metadado_final$hours <- as.factor(metadado_final$hours)
metadado_final$type <- as.factor(metadado_final$type)
metadado_final$brach <- as.factor(metadado_final$brach)


# Cria objeto DESeq2 com dados brutos
dds_filtred <- DESeqDataSetFromMatrix(
  countData = as.matrix(counts_filtrada_biotipo), # Matriz de contagens
  colData   = metadado_final,               # Metadados
  design    = ~ hours + type + brach        # Variável de interesse
)

dds_dge_filtred <- DESeq(dds_filtred)

resultsNames(dds_dge_filtred)

res_time_filtred <- DESeq2::results(dds_dge_filtred, name = "hours_72_vs_24")

# Comparação do efeito do tratamento (independente das horas)
#res_type <- DESeq2::results(dds_dge, contrast=c("type", "Reteno", "Control"))
#summary(res_type)

#res_time <- DESeq2::results(dds_dge, contrast = c("hours", "72h", "24h"))
#summary(res_time)

# MA-plot
plotMA(res_time_filtred)

# Transformar em dataframe
df_res_dge_filtred <- as.data.frame(res_time_filtred)

# Remveno NAs
df_res_dge_filtred <- na.omit(df_res_dge_filtred)

# Salva objetos para análises futuras
save(dds_dge_filtred, df_res_dge_filtred, file = "RDatas/RESULTS_DGE_FILTRED.RData")
```

### Data construction for the volcano plot

```{r}
vulcano_DGE_filtred<- data.frame(df_res_dge_filtred)

# Vulcano plot para DGE padj <= 0.015####
vulcano_DGE_filtred <- vulcano_DGE_filtred %>%
  # Garantir que colunas essenciais existem e estão limpas
  mutate(
    padj = ifelse(is.na(padj), 1, padj),                   # substitui NA por 1
    log2FoldChange = ifelse(is.na(log2FoldChange), 0, log2FoldChange),
    
    # Classificação dos genes
    signif = case_when(
      padj <= 0.05 & log2FoldChange > 1  ~ "Upregulated",
      padj <= 0.05 & log2FoldChange < -1 ~ "Downregulated",
      TRUE ~ "Not significant"
    ),
    
    # Ordem lógica dos fatores
    signif = factor(signif, 
                    levels = c("Downregulated", "Not significant", "Upregulated")),
    
    # Evitar Inf quando padj = 0
    padj = ifelse(padj == 0, 1e-300, padj),
    
    # Eixo Y do volcano plot
    log10padj = -log10(padj)
  )

# Calcular os valores a partir da tabela filtrada com padj <= 0.05
DGE_down_filtred <- sum(vulcano_DGE_filtred$signif == "Downregulated")
DGE_ns_filtred   <- sum(vulcano_DGE_filtred$signif == "Not significant")
DGE_up_filtred   <- sum(vulcano_DGE_filtred$signif == "Upregulated")
```

### Generating plot

```{r}
# Salvando o vulcano plot 
png("imgs/Vulcano_DGE_RNA_FILTRED.png", 
    width = 2000, 
    height = 2000, 
    res = 250)

# Criar Volcano plot usando ggplot2
ggplot(vulcano_DGE_filtred, aes(x = log2FoldChange, y = log10padj, color = signif)) +
  
  # Adicionar pontos representando os genes
  geom_point(alpha = 0.6, size = 1.4) +
  
  # Definir cores personalizadas para cada categoria de significância
  scale_color_manual(values = c(
    "Downregulated" = "#2166AC",
    "Not significant" = "gray80",
    "Upregulated" = "#B2182B"
  )) +
  
  # Adicionar linhas de corte (thresholds)
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black", linewidth = 0.3) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black", linewidth = 0.3) +
  
  # Anotar no gráfico com base nessa contagem
  annotate("text", x = -15, y = 75, label = paste("Down:", DGE_down_filtred), color = "#2166AC", hjust = 0) +
  annotate("text", x = 0, y = 75, label = paste("NS:", DGE_ns_filtred), color = "gray40", hjust = 0.5) +
  annotate("text", x = 15, y = 75, label = paste("Up:", DGE_up_filtred), color = "#B2182B", hjust = 1) +
  
  # Ajustar eixos com limites e espaçamento
  scale_x_continuous(limits = c(-15, 15), expand = expansion(mult = 0.02)) +
  scale_y_continuous(limits = c(0, 100), expand = expansion(mult = 0.02)) +
  
  # Títulos dos eixos e legenda
  labs(
    x = expression(log[2]~Fold~Change),
    y = expression(-log[10]~"adjusted p-value"),
    color = "Significance"
  ) +
  
  # Estilização geral do gráfico
  theme_minimal(base_size = 13, base_family = "Helvetica") +
  theme(
    panel.grid = element_blank(),
    legend.position = "top",
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10),
    axis.title = element_text(size = 13),
    axis.text = element_text(color = "black", size = 10),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    plot.subtitle = element_text(hjust = 0.5, size = 11)
  ) +
  ggtitle("Volcano Plot for the Differentially Expressed Genes (DGE)",         
          subtitle = "ncRNAs with padj < 0.05")

dev.off()

save(vulcano_DGE_filtred, DGE_down_filtred, DGE_ns_filtred, DGE_up_filtred, file = "RDatas/VULCONO_DGE_FILTRED.RData")
```

# Filtred RNA vulcano plot

```{r}
# Extraindo as listas de IDs (garantindo que sejam vetores de texto)
lncRNA_list_dge <- lncRNA_list$gene_id[lncRNA_list$gene_type == "lncRNA"]
miRNA_list_dge  <- miRNA_list$gene_id[miRNA_list$gene_type == "miRNA"]

# Pegar apenas as linhas de lncRNA
DGE_lncRNA <- vulcano_DGE_filtred[rownames(vulcano_DGE_filtred) %in% lncRNA_list_dge, ]

# Pegar apenas as linhas de miRNA
DGE_miRNA  <- vulcano_DGE_filtred[rownames(vulcano_DGE_filtred) %in% miRNA_list_dge, ]

```

## lncRNA plot

```{r}
# Vulcano plot para DGE padj <= 0.015####
DGE_lncRNA <- DGE_lncRNA %>%
  # Garantir que colunas essenciais existem e estão limpas
  mutate(
    padj = ifelse(is.na(padj), 1, padj),                   # substitui NA por 1
    log2FoldChange = ifelse(is.na(log2FoldChange), 0, log2FoldChange),
    
    # Classificação dos genes
    signif = case_when(
      padj <= 0.05 & log2FoldChange > 1  ~ "Upregulated",
      padj <= 0.05 & log2FoldChange < -1 ~ "Downregulated",
      TRUE ~ "Not significant"
    ),
    
    # Ordem lógica dos fatores
    signif = factor(signif, 
                    levels = c("Downregulated", "Not significant", "Upregulated")),
    
    # Evitar Inf quando padj = 0
    padj = ifelse(padj == 0, 1e-300, padj),
    
    # Eixo Y do volcano plot
    log10padj = -log10(padj)
  )

# Calcular os valores a partir da tabela filtrada com padj <= 0.05
DGE_lncRNA_down <- sum(DGE_lncRNA$signif == "Downregulated")
DGE_lncRNA_ns   <- sum(DGE_lncRNA$signif == "Not significant")
DGE_lncRNA_up   <- sum(DGE_lncRNA$signif == "Upregulated")
```

```{r}
# Salvando o vulcano plot 
png("imgs/Vulcano_DGE_RNA_LNCRNA.png", 
    width = 2000, 
    height = 2000, 
    res = 250)

# Criar Volcano plot usando ggplot2
ggplot(DGE_lncRNA, aes(x = log2FoldChange, y = log10padj, color = signif)) +
  
  # Adicionar pontos representando os genes
  geom_point(alpha = 0.6, size = 1.4) +
  
  # Definir cores personalizadas para cada categoria de significância
  scale_color_manual(values = c(
    "Downregulated" = "#2166AC",
    "Not significant" = "gray80",
    "Upregulated" = "#B2182B"
  )) +
  
  # Adicionar linhas de corte (thresholds)
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black", linewidth = 0.3) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black", linewidth = 0.3) +
  
  # Anotar no gráfico com base nessa contagem
  annotate("text", x = -15, y = 75, label = paste("Down:", DGE_lncRNA_down), color = "#2166AC", hjust = 0) +
  annotate("text", x = 0, y = 75, label = paste("NS:", DGE_lncRNA_ns), color = "gray40", hjust = 0.5) +
  annotate("text", x = 15, y = 75, label = paste("Up:", DGE_lncRNA_up), color = "#B2182B", hjust = 1) +
  
  # Ajustar eixos com limites e espaçamento
  scale_x_continuous(limits = c(-15, 15), expand = expansion(mult = 0.02)) +
  scale_y_continuous(limits = c(0, 100), expand = expansion(mult = 0.02)) +
  
  # Títulos dos eixos e legenda
  labs(
    x = expression(log[2]~Fold~Change),
    y = expression(-log[10]~"adjusted p-value"),
    color = "Significance"
  ) +
  
  # Estilização geral do gráfico
  theme_minimal(base_size = 13, base_family = "Helvetica") +
  theme(
    panel.grid = element_blank(),
    legend.position = "top",
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10),
    axis.title = element_text(size = 13),
    axis.text = element_text(color = "black", size = 10),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    plot.subtitle = element_text(hjust = 0.5, size = 11)
  ) +
  ggtitle("Volcano Plot for the Differentially Expressed Genes (DGE)",         
          subtitle = "lncRNAs with padj < 0.05")

dev.off()

save(vulcano_DGE_filtred, DGE_down_filtred, DGE_ns_filtred, DGE_up_filtred, file = "RDatas/VULCONO_DGE_LNCRNA.RData")
```

## miRNA

```{r}
# Vulcano plot para DGE padj <= 0.015####
DGE_miRNA <- DGE_miRNA %>%
  # Garantir que colunas essenciais existem e estão limpas
  mutate(
    padj = ifelse(is.na(padj), 1, padj),                   # substitui NA por 1
    log2FoldChange = ifelse(is.na(log2FoldChange), 0, log2FoldChange),
    
    # Classificação dos genes
    signif = case_when(
      padj <= 0.05 & log2FoldChange > 1  ~ "Upregulated",
      padj <= 0.05 & log2FoldChange < -1 ~ "Downregulated",
      TRUE ~ "Not significant"
    ),
    
    # Ordem lógica dos fatores
    signif = factor(signif, 
                    levels = c("Downregulated", "Not significant", "Upregulated")),
    
    # Evitar Inf quando padj = 0
    padj = ifelse(padj == 0, 1e-300, padj),
    
    # Eixo Y do volcano plot
    log10padj = -log10(padj)
  )

# Calcular os valores a partir da tabela filtrada com padj <= 0.05
DGE_miRNA_down <- sum(DGE_miRNA$signif == "Downregulated")
DGE_miRNA_ns   <- sum(DGE_miRNA$signif == "Not significant")
DGE_miRNA_up   <- sum(DGE_miRNA$signif == "Upregulated")
```

```{r}
# Salvando o vulcano plot 
png("imgs/Vulcano_DGE_RNA_MICRNA.png", 
    width = 2000, 
    height = 2000, 
    res = 250)

# Criar Volcano plot usando ggplot2
ggplot(DGE_miRNA, aes(x = log2FoldChange, y = log10padj, color = signif)) +
  
  # Adicionar pontos representando os genes
  geom_point(alpha = 0.6, size = 1.4) +
  
  # Definir cores personalizadas para cada categoria de significância
  scale_color_manual(values = c(
    "Downregulated" = "#2166AC",
    "Not significant" = "gray80",
    "Upregulated" = "#B2182B"
  )) +
  
  # Adicionar linhas de corte (thresholds)
  geom_vline(xintercept = c(-1, 1), linetype = "dashed", color = "black", linewidth = 0.3) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "black", linewidth = 0.3) +
  
  # Anotar no gráfico com base nessa contagem
  annotate("text", x = -15, y = 75, label = paste("Down:", DGE_miRNA_down), color = "#2166AC", hjust = 0) +
  annotate("text", x = 0, y = 75, label = paste("NS:", DGE_miRNA_ns), color = "gray40", hjust = 0.5) +
  annotate("text", x = 15, y = 75, label = paste("Up:", DGE_miRNA_up), color = "#B2182B", hjust = 1) +
  
  # Ajustar eixos com limites e espaçamento
  scale_x_continuous(limits = c(-15, 15), expand = expansion(mult = 0.02)) +
  scale_y_continuous(limits = c(0, 100), expand = expansion(mult = 0.02)) +
  
  # Títulos dos eixos e legenda
  labs(
    x = expression(log[2]~Fold~Change),
    y = expression(-log[10]~"adjusted p-value"),
    color = "Significance"
  ) +
  
  # Estilização geral do gráfico
  theme_minimal(base_size = 13, base_family = "Helvetica") +
  theme(
    panel.grid = element_blank(),
    legend.position = "top",
    legend.title = element_text(size = 11),
    legend.text = element_text(size = 10),
    axis.title = element_text(size = 13),
    axis.text = element_text(color = "black", size = 10),
    plot.title = element_text(hjust = 0.5, face = "bold", size = 14),
    plot.subtitle = element_text(hjust = 0.5, size = 11)
  ) +
  ggtitle("Volcano Plot for the Differentially Expressed Genes (DGE)",         
          subtitle = "miRNAs with padj < 0.05")

dev.off()

save(DGE_miRNA, DGE_miRNA_down, DGE_miRNA_ns, DGE_miRNA_up, file = "RDatas/VULCONO_DGE_MICRNA.RData")
```
